<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>laravel-09 用戶身分驗證與授權 | Vince的學習筆記</title>
    <meta name="author" content="Vince Lo" />
    <meta name="keywords" content="" />
    <meta name="description" content=" 用戶模型與 migration9-1 Laravel的預設user migration12345678Schema::create(&#39;users&#39;, function (Blueprint $table) &amp;#123;    $table-&amp;gt;increments(&#39;id&#39;);    $table-&amp;gt;string(&#39;name&#39;);    $table-&amp;gt;string(&#39;email&#39;)-&amp;gt;unique();    $table-&amp;gt;string(&#39;passwo..." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Vince的學習筆記" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]>
    <style type="text/css">
    .nav-inner {top:0;}
    .author-meta {position:static;top:0;}
    .search-form {height:36px;}
    </style>
    <script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 4.2.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Vince的學習筆記</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首頁</span>
            </a>
        
            <a class="nav-item" href="/categories/design">
                <span class="nav-text">設計</span>
            </a>
        
            <a class="nav-item" href="/categories/frontend">
                <span class="nav-text">前端</span>
            </a>
        
            <a class="nav-item" href="/categories/backend">
                <span class="nav-text">後端</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">標籤</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">歸檔</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">關於</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://vince115.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#用戶模型與-migration"><span class="toc-number">1.</span> <span class="toc-text"> 用戶模型與 migration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用auth-全域輔助函式與auth靜態介面"><span class="toc-number">2.</span> <span class="toc-text"> 使用auth() 全域輔助函式與Auth靜態介面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#auth-控制器"><span class="toc-number">3.</span> <span class="toc-text"> Auth 控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#registercontroller"><span class="toc-number">4.</span> <span class="toc-text"> RegisterController</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#registeruser-特徵"><span class="toc-number">4.0.1.</span> <span class="toc-text"> RegisterUser 特徵</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#logincontroller"><span class="toc-number">4.1.</span> <span class="toc-text"> LoginController</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#authenticatesusers-特徵"><span class="toc-number">4.1.1.</span> <span class="toc-text"> AuthenticatesUsers 特徵</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#throttleslogins-特徵"><span class="toc-number">4.1.2.</span> <span class="toc-text"> ThrottlesLogins 特徵</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#resetpasswordcontroller"><span class="toc-number">4.2.</span> <span class="toc-text"> ResetPasswordController</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#authroutes-路由"><span class="toc-number">5.</span> <span class="toc-text"> Auth::routes() 路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#auth-鷹架"><span class="toc-number">6.</span> <span class="toc-text"> Auth 鷹架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#記住我"><span class="toc-number">7.</span> <span class="toc-text"> “記住我”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手動驗證用戶"><span class="toc-number">8.</span> <span class="toc-text"> 手動驗證用戶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#驗證中介層"><span class="toc-number">9.</span> <span class="toc-text"> 驗證中介層</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#守衛"><span class="toc-number">10.</span> <span class="toc-text"> 守衛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#改變預設的守衛"><span class="toc-number">10.1.</span> <span class="toc-text"> 改變預設的守衛</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用其他的守衛而不改變預設值"><span class="toc-number">10.2.</span> <span class="toc-text"> 使用其他的守衛而不改變預設值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#增加新守衛"><span class="toc-number">10.3.</span> <span class="toc-text"> 增加新守衛</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#建立自訂的用戶供應器"><span class="toc-number">10.4.</span> <span class="toc-text"> 建立自訂的用戶供應器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#為非關聯式資料庫自訂user供應器"><span class="toc-number">10.5.</span> <span class="toc-text"> 為非關聯式資料庫自訂user供應器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#驗證事件"><span class="toc-number">11.</span> <span class="toc-text"> 驗證事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#授權acl與角色"><span class="toc-number">12.</span> <span class="toc-text"> 授權(ACL)與角色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定義授權規則"><span class="toc-number">12.1.</span> <span class="toc-text"> 定義授權規則</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gate靜態介面與注入gate"><span class="toc-number">12.2.</span> <span class="toc-text"> Gate靜態介面(與注入Gate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#授權中介層"><span class="toc-number">12.3.</span> <span class="toc-text"> 授權中介層</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#控制器授權"><span class="toc-number">12.4.</span> <span class="toc-text"> 控制器授權</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用戶實例檢查"><span class="toc-number">12.5.</span> <span class="toc-text"> 用戶實例檢查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#blade-檢查"><span class="toc-number">12.6.</span> <span class="toc-text"> Blade 檢查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#攔截檢查"><span class="toc-number">12.7.</span> <span class="toc-text"> 攔截檢查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#政策"><span class="toc-number">12.8.</span> <span class="toc-text"> 政策</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#產生政策"><span class="toc-number">12.9.</span> <span class="toc-text"> 產生政策</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#檢查政策"><span class="toc-number">12.10.</span> <span class="toc-text"> 檢查政策</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#覆寫政策"><span class="toc-number">12.11.</span> <span class="toc-text"> 覆寫政策</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#測試"><span class="toc-number">13.</span> <span class="toc-text"> 測試</span></a></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            laravel-09 用戶身分驗證與授權
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://vince115.github.io/2020/05/06/laravel-09/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2020-05-06T03:26:16.000Z" itemprop="datePublished">2020-05-06</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/backend/" rel="tag">backend</a>, <a class="article-tag-link" href="/tags/laravel/" rel="tag">laravel</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h3 id="用戶模型與-migration"><a class="markdownIt-Anchor" href="#用戶模型與-migration"></a> 用戶模型與 migration</h3>
<p>9-1 Laravel的預設user migration</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">    $table-&gt;increments(<span class="string">'id'</span>);</span><br><span class="line">    $table-&gt;string(<span class="string">'name'</span>);</span><br><span class="line">    $table-&gt;string(<span class="string">'email'</span>)-&gt;unique();</span><br><span class="line">    $table-&gt;string(<span class="string">'password'</span>);</span><br><span class="line">    $table-&gt;rememberToken();</span><br><span class="line">    $table-&gt;timestamps();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>9-2 Laravel 的預設user模型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// App\User</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Notifiable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Notifiable</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The attributes that are mass assignable.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> $fillable = [</span><br><span class="line"><span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'password'</span>,</span><br><span class="line">];</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* The attributes excluded from the model's JSON form.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> $hidden = [</span><br><span class="line"><span class="string">'password'</span>, <span class="string">'remember_token'</span>,</span><br><span class="line">];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Illuminate\Foundation\Auth\User</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Authenticatable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Passwords</span>\<span class="title">CanResetPassword</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">Access</span>\<span class="title">Authorizable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Authenticatable</span> <span class="title">as</span> <span class="title">AuthenticatableContract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Access</span>\<span class="title">Authorizable</span> <span class="title">as</span> <span class="title">AuthorizableContract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">CanResetPassword</span> <span class="title">as</span> <span class="title">CanResetPasswordContract</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class"><span class="title">AuthenticatableContract</span>,</span></span><br><span class="line"><span class="class"><span class="title">AuthorizableContract</span>,</span></span><br><span class="line"><span class="class"><span class="title">CanResetPasswordContract</span></span></span><br><span class="line"><span class="class"><span class="title">esetPasswordContract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   useAuthenticatable,Authorizable,CanResetPassword;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用auth-全域輔助函式與auth靜態介面"><a class="markdownIt-Anchor" href="#使用auth-全域輔助函式與auth靜態介面"></a> 使用auth() 全域輔助函式與Auth靜態介面</h3>
<p>9-3 Rgister</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="auth-控制器"><a class="markdownIt-Anchor" href="#auth-控制器"></a> Auth 控制器</h3>
<h3 id="registercontroller"><a class="markdownIt-Anchor" href="#registercontroller"></a> RegisterController</h3>
<p>9-4 Laravel 預設的 RgisterController</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">RegistersUsers</span>;</span><br><span class="line">    <span class="keyword">protected</span> $redirectTo = <span class="string">'/home'</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">validator</span><span class="params">(array $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Validator::make($data, [</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'required|max:255'</span>,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|email|max:255|unique:users'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|min:6|confirmed'</span>,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(array $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> User::create([</span><br><span class="line">            <span class="string">'name'</span> =&gt; $data[<span class="string">'name'</span>],</span><br><span class="line">            <span class="string">'email'</span> =&gt; $data[<span class="string">'email'</span>],</span><br><span class="line">            <span class="string">'password'</span> =&gt; bcrypt($data[<span class="string">'password'</span>]),</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="registeruser-特徵"><a class="markdownIt-Anchor" href="#registeruser-特徵"></a> RegisterUser 特徵</h5>
<h4 id="logincontroller"><a class="markdownIt-Anchor" href="#logincontroller"></a> LoginController</h4>
<h5 id="authenticatesusers-特徵"><a class="markdownIt-Anchor" href="#authenticatesusers-特徵"></a> AuthenticatesUsers 特徵</h5>
<h5 id="throttleslogins-特徵"><a class="markdownIt-Anchor" href="#throttleslogins-特徵"></a> ThrottlesLogins 特徵</h5>
<h4 id="resetpasswordcontroller"><a class="markdownIt-Anchor" href="#resetpasswordcontroller"></a> ResetPasswordController</h4>
<h3 id="authroutes-路由"><a class="markdownIt-Anchor" href="#authroutes-路由"></a> Auth::routes() 路由</h3>
<p>9-5 Auth::提供的路由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authentication Routes</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;get(<span class="string">'login'</span>, <span class="string">'Auth\LoginController@showLoginForm'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;post(<span class="string">'login'</span>, <span class="string">'Auth\LoginController@login'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;get(<span class="string">'logout'</span>, <span class="string">'Auth\LoginController@logout'</span>);</span><br><span class="line"><span class="comment">// Registration Routes</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;get(<span class="string">'register'</span>, <span class="string">'Auth\RegisterController@showRegistrationForm'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;post(<span class="string">'register'</span>, <span class="string">'Auth\RegisterController@register'</span>);</span><br><span class="line"><span class="comment">// Password Reset Routes</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;get(<span class="string">'password/reset'</span>, <span class="string">'Auth\ForgotPasswordController@showLinkRequestForm'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;post(<span class="string">'password/email'</span>, <span class="string">'Auth\ForgotPasswordController@sendResetLinkEmail'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;get(<span class="string">'password/reset/&#123;token&#125;'</span>, <span class="string">'Auth\ResetPasswordController@showResetForm'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;post(<span class="string">'password/reset'</span>, <span class="string">'Auth\ResetPasswordController@reset'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="auth-鷹架"><a class="markdownIt-Anchor" href="#auth-鷹架"></a> Auth 鷹架</h3>
<h3 id="記住我"><a class="markdownIt-Anchor" href="#記住我"></a> “記住我”</h3>
<p>9-6 嘗試進行用戶身分驗證</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (auth()-&gt;attempt([</span><br><span class="line">    <span class="string">'email'</span> =&gt; request()-&gt;input(<span class="string">'email'</span>),</span><br><span class="line">    <span class="string">'password'</span> =&gt; request()-&gt;input(<span class="string">'password'</span>)</span><br><span class="line">    ])) &#123;</span><br><span class="line">    <span class="comment">// Handle the successful login</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-7 使用&quot;記住我&quot;確認方塊來做身分確認</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (auth()-&gt;attempt([</span><br><span class="line">    <span class="string">'email'</span> =&gt; request()-&gt;input(<span class="string">'email'</span>),</span><br><span class="line">    <span class="string">'password'</span> =&gt; request()-&gt;input(<span class="string">'password'</span>)</span><br><span class="line">    ]), request()-&gt;has(<span class="string">'remember'</span>)) &#123;</span><br><span class="line">    <span class="comment">// Handle the successful login</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="手動驗證用戶"><a class="markdownIt-Anchor" href="#手動驗證用戶"></a> 手動驗證用戶</h3>
<h3 id="驗證中介層"><a class="markdownIt-Anchor" href="#驗證中介層"></a> 驗證中介層</h3>
<p>9-8 使用Blade的@cannot指令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'account'</span>, <span class="string">'AccountController@dashboard'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">Route::get(<span class="string">'login'</span>, <span class="string">'Auth\LoginController@getLogin'</span>)-&gt;middleware(<span class="string">'guest'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="守衛"><a class="markdownIt-Anchor" href="#守衛"></a> 守衛</h3>
<h4 id="改變預設的守衛"><a class="markdownIt-Anchor" href="#改變預設的守衛"></a> 改變預設的守衛</h4>
<h4 id="使用其他的守衛而不改變預設值"><a class="markdownIt-Anchor" href="#使用其他的守衛而不改變預設值"></a> 使用其他的守衛而不改變預設值</h4>
<h4 id="增加新守衛"><a class="markdownIt-Anchor" href="#增加新守衛"></a> 增加新守衛</h4>
<h4 id="建立自訂的用戶供應器"><a class="markdownIt-Anchor" href="#建立自訂的用戶供應器"></a> 建立自訂的用戶供應器</h4>
<h4 id="為非關聯式資料庫自訂user供應器"><a class="markdownIt-Anchor" href="#為非關聯式資料庫自訂user供應器"></a> 為非關聯式資料庫自訂user供應器</h4>
<h3 id="驗證事件"><a class="markdownIt-Anchor" href="#驗證事件"></a> 驗證事件</h3>
<p>9-9 框架生成的驗證事件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $listen = [</span><br><span class="line">    <span class="string">'Illuminate\Auth\Events\Attempting'</span> =&gt; [],</span><br><span class="line">    <span class="string">'Illuminate\Auth\Events\Login'</span> =&gt; [],</span><br><span class="line">    <span class="string">'Illuminate\Auth\Events\Logout'</span> =&gt; [],</span><br><span class="line">    <span class="string">'Illuminate\Auth\Events\Lockout'</span> =&gt; [],</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="授權acl與角色"><a class="markdownIt-Anchor" href="#授權acl與角色"></a> 授權(ACL)與角色</h3>
<h4 id="定義授權規則"><a class="markdownIt-Anchor" href="#定義授權規則"></a> 定義授權規則</h4>
<p>9-10 更新聯絡資訊的能力範例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">(GateContract $gate)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPolicies($gate);</span><br><span class="line">        $gate-&gt;define(<span class="string">'update-contact'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user, $contact)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $user-&gt;id === $contact-&gt;user_id;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="gate靜態介面與注入gate"><a class="markdownIt-Anchor" href="#gate靜態介面與注入gate"></a> Gate靜態介面(與注入Gate)</h4>
<p>9-11 基本的Gate靜態介面用法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Gate::allows(<span class="string">'update-contact'</span>, $contact)) &#123;</span><br><span class="line">    <span class="comment">// Update contact</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// or...</span></span><br><span class="line"><span class="keyword">if</span> (Gate::denies(<span class="string">'update-contact'</span>, $contact)) &#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-12 使用多個參數的能力</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Definition</span></span><br><span class="line">$gate-&gt;define(<span class="string">'add-contact-to-group'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user, $contact, $group)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $user-&gt;id === $contact-&gt;user_id &amp;&amp; $user-&gt;id === $group-&gt;user_id;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Usage</span></span><br><span class="line"><span class="keyword">if</span> (Gate::denies(<span class="string">'add-contact-to-group'</span>, [$contact, $group])) &#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-13 指定Gate用戶</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Gate::forUser($user)-&gt;denies(<span class="string">'create-contact'</span>)) &#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="授權中介層"><a class="markdownIt-Anchor" href="#授權中介層"></a> 授權中介層</h4>
<p>9-14 使用授權中介層</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'people/create'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// Create person...</span></span><br><span class="line">&#125;)-&gt;middleware(<span class="string">'can:create-person'</span>);</span><br><span class="line">Route::get(<span class="string">'people/&#123;person&#125;/edit'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// Create person...</span></span><br><span class="line">&#125;)-&gt;middleware(<span class="string">'can:create,person'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="控制器授權"><a class="markdownIt-Anchor" href="#控制器授權"></a> 控制器授權</h4>
<p>9-15 以authorize()簡化控制器授權</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// From this:</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($contactId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $contact = Contact::findOrFail($contactId);</span><br><span class="line">    <span class="keyword">if</span> (Gate::cannot(<span class="string">'update-contact'</span>, $contact)) &#123;</span><br><span class="line">    abort(<span class="number">403</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// To this:</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($contactId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$contact = Contact::findOrFail($contactId);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;authorize(<span class="string">'update-contact'</span>, $contact);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用戶實例檢查"><a class="markdownIt-Anchor" href="#用戶實例檢查"></a> 用戶實例檢查</h4>
<p>9-16 authorizeResource()從&quot;授權&quot;到&quot;方法&quot;的對應</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// This call does everything you see in the methods below.</span></span><br><span class="line">        <span class="comment">// If you put this here, you can remove all authorize</span></span><br><span class="line">        <span class="comment">// calls in the individual resource methods here.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorizeResource(Contact::class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'view'</span>, Contact::class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'create'</span>, Contact::class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'create'</span>, Contact::class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(Contact $contact)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'view'</span>, $contact);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">edit</span><span class="params">(Contact $contact)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'update'</span>, $contact);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(Request $request, Contact $contact)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'update'</span>, $contact);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">(Contact $contact)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;authorize(<span class="string">'delete'</span>, $contact);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-17 對用戶實例檢查授權</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$user = User::find(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ($user-&gt;can(<span class="string">'create-contact'</span>)) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="blade-檢查"><a class="markdownIt-Anchor" href="#blade-檢查"></a> Blade 檢查</h4>
<p>9-18 使用Blade的@can指令</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">@can('edit-contact', $contact)</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; route('contacts.edit', [$contact-&gt;id]) &#125;&#125;"</span>&gt;</span>Edit This Contact<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">@endcan</span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>9-19 使用Blade的@cannot指令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;&#123;&#123; $contact-&gt;name &#125;&#125;&lt;/h1&gt;</span><br><span class="line">@cannot(<span class="string">'edit-contact'</span>, $contact)</span><br><span class="line">LOCKED</span><br><span class="line">@endcannot</span><br></pre></td></tr></table></figure>
<h4 id="攔截檢查"><a class="markdownIt-Anchor" href="#攔截檢查"></a> 攔截檢查</h4>
<p>9-20 使用before()來覆寫Gate檢查</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$gate-&gt;before(<span class="function"><span class="keyword">function</span> <span class="params">($user, $ability)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($user-&gt;isOwner()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="政策"><a class="markdownIt-Anchor" href="#政策"></a> 政策</h4>
<h4 id="產生政策"><a class="markdownIt-Anchor" href="#產生政策"></a> 產生政策</h4>
<blockquote>
<p>php artisan make:policy CantactPolicy</p>
</blockquote>
<p>9-21 update政策方法範例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Policies</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactPolicy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($user, $contact)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $user-&gt;id === $contact-&gt;user_id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="檢查政策"><a class="markdownIt-Anchor" href="#檢查政策"></a> 檢查政策</h4>
<p>9-22 以政策檢查授權</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Gate</span></span><br><span class="line"><span class="keyword">if</span> (Gate::denies(<span class="string">'update'</span>, $contact)) &#123;</span><br><span class="line">abort(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Gate if you don't have an explicit instance</span></span><br><span class="line"><span class="keyword">if</span> (! Gate::check(<span class="string">'create'</span>, Contact::class)) &#123;</span><br><span class="line">abort(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// User</span></span><br><span class="line"><span class="keyword">if</span> ($user-&gt;can(<span class="string">'update'</span>, $contact)) &#123;</span><br><span class="line"><span class="comment">// Do stuff</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Blade</span></span><br><span class="line">@can(<span class="string">'update'</span>, $contact)</span><br><span class="line">&lt;!-- show stuff --&gt;</span><br><span class="line">@endcan</span><br></pre></td></tr></table></figure>
<h4 id="覆寫政策"><a class="markdownIt-Anchor" href="#覆寫政策"></a> 覆寫政策</h4>
<p>9-23 使用before方法來覆寫政策</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">before</span><span class="params">($user, $ability)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($user-&gt;isAdmin()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="測試"><a class="markdownIt-Anchor" href="#測試"></a> 測試</h3>
<p>9-24 在應用測試中扮演用戶來進行驗證</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_it_creates_a_new_contact</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = factory(User::class)-&gt;create();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;be($user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;post(<span class="string">'contacts'</span>, [</span><br><span class="line">        <span class="string">'email'</span> =&gt; <span class="string">'my@email.com'</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;seeInDatabase(<span class="string">'contacts'</span>, [</span><br><span class="line">        <span class="string">'email'</span> =&gt; <span class="string">'my@email.com'</span>,</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; $user-&gt;id,</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-25 測試授權規則</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_non_admins_cant_create_users</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = factory(User::class)-&gt;create([</span><br><span class="line">        <span class="string">'admin'</span> =&gt; <span class="keyword">false</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;be($user);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;post(<span class="string">'users'</span>, [<span class="string">'email'</span> =&gt; <span class="string">'my@email.com'</span>]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;dontSeeInDatabase(<span class="string">'users'</span>, [</span><br><span class="line">        <span class="string">'email'</span> =&gt; <span class="string">'my@email.com'</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-26 檢查狀態碼來測試授權</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_non_admins_cant_create_users</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = factory(User::class)-&gt;create([</span><br><span class="line">        <span class="string">'admin'</span> =&gt; <span class="keyword">false</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;be($user);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;post(<span class="string">'users'</span>, [<span class="string">'email'</span> =&gt; <span class="string">'my@email.com'</span>]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;assertResponseStatus(<span class="number">403</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9-27 測試授權路由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_users_can_register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;post(<span class="string">'register'</span>, [</span><br><span class="line">    <span class="string">'name'</span> =&gt; <span class="string">'Sal Leibowitz'</span>,</span><br><span class="line">    <span class="string">'email'</span> =&gt; <span class="string">'sal@leibs.net'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'abcdefg123'</span>,</span><br><span class="line">    <span class="string">'password_confirmation'</span> =&gt; <span class="string">'abcdefg123'</span>,</span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">$this</span>-&gt;followRedirects()-&gt;assertResponseOk();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;seeInDatabase(<span class="string">'users'</span>, [</span><br><span class="line">    <span class="string">'name'</span> =&gt; <span class="string">'Sal Leibowitz'</span>,</span><br><span class="line">    <span class="string">'email'</span> =&gt; <span class="string">'sal@leibs.net'</span>,</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_users_can_log_in</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = factory(User::class)-&gt;create([</span><br><span class="line">        <span class="string">'password'</span> =&gt; bcrypt(<span class="string">'abcdefg123'</span>)</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;post(<span class="string">'login'</span>, [</span><br><span class="line">    <span class="string">'email'</span> =&gt; $user-&gt;email,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'abcdefg123'</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;followRedirects()-&gt;assertResponseOk();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">$this</span>-&gt;assertTrue(auth()-&gt;check());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
    </section>
</article>



<a id="pagenext" href="/2020/05/01/laravel-08/" class="article-next" title="laravel-08"><i class="icon-arrow-right"></i></a>


<a id="pageprev" href="/2020/05/07/laravel-10/" class="article-prev" title="laravel-10 請求與回應"><i class="icon-arrow-left"></i></a>



<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "7fbe80427f54741e289f",
        clientSecret: "f34ed5fd92e54c9000bd37ba951948cb939deff5",
        repo: "sanonz.github.io",
        owner: "sanonz",
        admin: ["sanonz"],
        id: "2020/05/06/laravel-09",
        distractionFreeMode: true,
        title: "laravel-09 用戶身分驗證與授權",
        body: "http://vince115.github.io/2020/05/06/laravel-09/",
        labels: ["laravel","backend"]
    }).render('comments');
    </script>
</div>


            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
