<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>laravel-13 編寫API | Vince的學習筆記</title>
    <meta name="author" content="Vince Lo" />
    <meta name="keywords" content="" />
    <meta name="description" content="###類Rest Json API 基礎13-1 常見的REST API端點結構12345678910111213141516171819202122232425262728GET /api/cats[    &amp;#123;        id: 1,        name: &#39;Fluffy&#39;    &amp;#125;,    &amp;#123;        id: 2,        name: &#39;Killer&#39;    &amp;#125;]GET /api/cats/2    &amp;#123;     ..." />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Vince的學習筆記" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]>
    <style type="text/css">
    .nav-inner {top:0;}
    .author-meta {position:static;top:0;}
    .search-form {height:36px;}
    </style>
    <script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 4.2.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Vince的學習筆記</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首頁</span>
            </a>
        
            <a class="nav-item" href="/categories/design">
                <span class="nav-text">設計</span>
            </a>
        
            <a class="nav-item" href="/categories/frontend">
                <span class="nav-text">前端</span>
            </a>
        
            <a class="nav-item" href="/categories/backend">
                <span class="nav-text">後端</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">標籤</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">歸檔</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">關於</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://vince115.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#eloquent-分頁"><span class="toc-number">1.</span> <span class="toc-text"> Eloquent 分頁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#排序你的api結果"><span class="toc-number">2.</span> <span class="toc-text"> 排序你的API結果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#篩選你的api結果"><span class="toc-number">3.</span> <span class="toc-text"> 篩選你的API結果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#轉換結果"><span class="toc-number">4.</span> <span class="toc-text"> 轉換結果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#編寫你自己的轉換器"><span class="toc-number">4.1.</span> <span class="toc-text"> 編寫你自己的轉換器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#嵌套與關係"><span class="toc-number">4.2.</span> <span class="toc-text"> 嵌套與關係</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用laravel-passport-來做api身分驗證"><span class="toc-number">5.</span> <span class="toc-text"> 使用Laravel Passport 來做API身分驗證</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#oath-20-簡介"><span class="toc-number">5.1.</span> <span class="toc-text"> OAth 2.0 簡介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安裝passport"><span class="toc-number">5.2.</span> <span class="toc-text"> 安裝Passport</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#passport的api"><span class="toc-number">5.3.</span> <span class="toc-text"> Passport的API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#passport可用的授權類型"><span class="toc-number">5.4.</span> <span class="toc-text"> Passport可用的授權類型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#密碼授權"><span class="toc-number">5.5.</span> <span class="toc-text"> 密碼授權</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#授權密碼授予"><span class="toc-number">5.6.</span> <span class="toc-text"> 授權密碼授予</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用刷新權杖"><span class="toc-number">5.7.</span> <span class="toc-text"> 使用刷新權杖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用刷新權杖-2"><span class="toc-number">5.8.</span> <span class="toc-text"> 使用刷新權杖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#個人造訪權杖"><span class="toc-number">5.9.</span> <span class="toc-text"> 個人造訪權杖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#laravel-session-認證產生的權杖"><span class="toc-number">5.10.</span> <span class="toc-text"> Laravel session 認證產生的權杖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#json-web-tokenjwt"><span class="toc-number">5.11.</span> <span class="toc-text"> JSON Web Token(JWT)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用passwort-api與vue元件來管理用戶端與權杖"><span class="toc-number">5.12.</span> <span class="toc-text"> 使用Passwort API與Vue元件來管理用戶端與權杖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#路由"><span class="toc-number">5.13.</span> <span class="toc-text"> 路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vue元件"><span class="toc-number">5.14.</span> <span class="toc-text"> Vue元件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#密碼範圍"><span class="toc-number">5.15.</span> <span class="toc-text"> 密碼範圍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#laravel-52-api-權杖驗證"><span class="toc-number">5.16.</span> <span class="toc-text"> Laravel 5.2 + API 權杖驗證</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            laravel-13 編寫API
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://vince115.github.io/2020/06/29/laravel-13/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2020-06-29T08:20:10.000Z" itemprop="datePublished">2020-06-29</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>###類Rest Json API 基礎<br />
13-1 常見的REST API端點結構</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /api/cats</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        name: <span class="string">'Fluffy'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        id: <span class="number">2</span>,</span><br><span class="line">        name: <span class="string">'Killer'</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">GET /api/cats/<span class="number">2</span></span><br><span class="line">    &#123;</span><br><span class="line">        id: <span class="number">2</span>,</span><br><span class="line">        name: <span class="string">'Killer'</span></span><br><span class="line">    &#125;</span><br><span class="line">DELETE /api/cats/<span class="number">2</span></span><br><span class="line">deletes cat</span><br><span class="line">POST /api/cats with body:</span><br><span class="line">&#123;</span><br><span class="line">    name: <span class="string">'Mr Bigglesworth'</span></span><br><span class="line">&#125;</span><br><span class="line">(creates <span class="keyword">new</span> cat)</span><br><span class="line">PATCH /api/cats/<span class="number">3</span> with body:</span><br><span class="line">&#123;</span><br><span class="line">    name: <span class="string">'Mr. Bigglesworth'</span></span><br><span class="line">&#125;</span><br><span class="line">(updates cat)</span><br></pre></td></tr></table></figure>
<p>13-2 生成的資源控制器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DogsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Display a listing of the resource.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Show the form for creating a new resource.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Store a newly created resource in storage.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Display the specified resource.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int $id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($id)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Show the form for editing the specified resource.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int $id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">edit</span><span class="params">($id)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Update the specified resource in storage.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int $id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(Request $request, $id)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Remove the specified resource from storage.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int $id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($id)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13-3 Dog 實例的資源控制器樣本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DogsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Dog::all();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Dog::create($request-&gt;all());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Dog::findOrFail($id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(Request $request, $id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dog = Dog::findOrFail($id);</span><br><span class="line">        $dog-&gt;update($request-&gt;all());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dog = Dog::findOrFail($id);</span><br><span class="line">        $dog-&gt;delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13-4 綁定資源控制器路由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Routes.php</span></span><br><span class="line">Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>, <span class="string">'namespace'</span> =&gt; <span class="string">'Api'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::resource(<span class="string">'dogs'</span>, <span class="string">'DogsController'</span>);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p>13-5 在Laravel中傳送回應標頭</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response(Dog::all())</span><br><span class="line">    -&gt;header(<span class="string">'X-Greatness-Index'</span>, <span class="number">9</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>13-6 在Laravel中讀取請求標頭</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $request-&gt;header(<span class="string">'Accept'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="eloquent-分頁"><a class="markdownIt-Anchor" href="#eloquent-分頁"></a> Eloquent 分頁</h3>
<p>13-7 分頁後的API路由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Dog::paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Laravel會根據網頁查詢參數的設定值，來得之為我們拉出哪20筆結果<br />
GET /dogs - Return results 1-20<br />
GET /dogs?page=1 - Return results 1-20<br />
GET /dogs?page=2 - Return results 21-40</p>
<p>13-8 在查詢產生器呼叫式使用paginate()方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> DB::table(<span class="string">'dogs'</span>)-&gt;paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>13-9 分頁後的資料庫呼叫式的輸出範例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"total"</span>:<span class="number">50</span>,</span><br><span class="line">    <span class="string">"per_page"</span>:<span class="number">3</span>,</span><br><span class="line">    <span class="string">"current_page"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">"last_page"</span>: <span class="number">17</span>,</span><br><span class="line">    <span class="string">"next_page_url"</span>: <span class="string">"http://myapp.com/api/dogs?page=2"</span>,</span><br><span class="line">    <span class="string">"prev_page_url"</span>: <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">"from"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"to"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"data"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'Fido'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'Pickles'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'Spot'</span></span><br><span class="line">    &#125;</span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="排序你的api結果"><a class="markdownIt-Anchor" href="#排序你的api結果"></a> 排序你的API結果</h3>
<p>13-10 最簡單的API排序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line"><span class="comment">// Get the sort query parameter (or fall back to default sort "name")</span></span><br><span class="line">$sortCol = $request-&gt;input(<span class="string">'sort'</span>, <span class="string">'name'</span>);</span><br><span class="line"><span class="keyword">return</span> Dog::orderBy($sortCol)-&gt;paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>13-11 單欄位API排序，使用方向控制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handles /dogs?sort=name and /dogs?sort=-name</span></span><br><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line"><span class="comment">// Get the sort query parameter (or fall back to default sort "name")</span></span><br><span class="line">$sortCol = $request-&gt;input(<span class="string">'sort'</span>, <span class="string">'name'</span>);</span><br><span class="line"><span class="comment">// Set the sort direction based on whether the key starts with -</span></span><br><span class="line"><span class="comment">// using Laravel's starts_with() helper function</span></span><br><span class="line">$sortDir = starts_with($sortCol, <span class="string">'-'</span>) ? <span class="string">'desc'</span> : <span class="string">'asc'</span>;</span><br><span class="line">$sortCol = ltrim($sort, <span class="string">'-'</span>);</span><br><span class="line"><span class="keyword">return</span> Dog::orderBy($sortCol, $sortDir)</span><br><span class="line">-&gt;paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>13-12 JSON API　風格排序</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handles ?sort=name,-weight</span></span><br><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Grab the query parameter and turn it into an array exploded by ,</span></span><br><span class="line">    $sorts = explode(<span class="string">','</span>, $request-&gt;input(<span class="string">'sort'</span>, <span class="string">''</span>));</span><br><span class="line">    <span class="comment">// Create a query</span></span><br><span class="line">    $query = Dog::query();</span><br><span class="line">    <span class="comment">// Add the sorts one by one</span></span><br><span class="line">    <span class="keyword">foreach</span> ($sorts <span class="keyword">as</span> $sortCol) &#123;</span><br><span class="line">        $sortDir = starts_with($sortCol, <span class="string">'-'</span>) ? <span class="string">'desc'</span> : <span class="string">'asc'</span>;</span><br><span class="line">        $sortCol = ltrim($sort, <span class="string">'-'</span>);</span><br><span class="line">        $query-&gt;orderBy($sortCol, $sortDir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Return</span></span><br><span class="line">    <span class="keyword">return</span> $query-&gt;paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="篩選你的api結果"><a class="markdownIt-Anchor" href="#篩選你的api結果"></a> 篩選你的API結果</h3>
<p>13-13 對 API 結果使用單個filter</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    $query = Dog::query();</span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'filter'</span>)) &#123;</span><br><span class="line">        <span class="keyword">list</span>($criteria, $value) = explode(<span class="string">':'</span>, $request-&gt;input(<span class="string">'filter'</span>));</span><br><span class="line">        $query-&gt;where($criteria, $value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $query-&gt;paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>13-14 對 API 結果使用多個filter</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'dogs'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    $query = Dog::query();</span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'filter'</span>)) &#123;</span><br><span class="line">        $filters = explode(<span class="string">','</span>, $request-&gt;input(<span class="string">'filter'</span>));</span><br><span class="line">        <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">            <span class="keyword">list</span>($criteria, $value) = explode(<span class="string">':'</span>, $filter);</span><br><span class="line">            $query-&gt;where($criteria, $value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $query-&gt;paginate(<span class="number">20</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="轉換結果"><a class="markdownIt-Anchor" href="#轉換結果"></a> 轉換結果</h3>
<h4 id="編寫你自己的轉換器"><a class="markdownIt-Anchor" href="#編寫你自己的轉換器"></a> 編寫你自己的轉換器</h4>
<p>13-15 簡單的轉換器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'users/&#123;id&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> UserTransformer(User::findOrFail($userId)));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTransformer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $user;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">'id'</span> =&gt; <span class="keyword">$this</span>-&gt;user-&gt;id,</span><br><span class="line">    <span class="string">'name'</span> =&gt; sprintf(</span><br><span class="line">        <span class="string">"%s %s"</span>,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user-&gt;first_name,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user-&gt;last_name</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'friendsCount'</span> =&gt; <span class="keyword">$this</span>-&gt;user-&gt;friends-&gt;count()</span><br><span class="line">    ];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="嵌套與關係"><a class="markdownIt-Anchor" href="#嵌套與關係"></a> 嵌套與關係</h4>
<p>13-16 在轉換器內，允許選擇性內嵌資源</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'users/&#123;id&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($userId, Request $request)</span> </span>&#123;</span><br><span class="line"><span class="comment">// Get the embeds query parameter and split by commas</span></span><br><span class="line">$embeds = explode(<span class="string">','</span>, $request-&gt;input(<span class="string">'embed'</span>, <span class="string">''</span>));</span><br><span class="line"><span class="comment">// Pass both user and embeds to the user transformer</span></span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">new</span> UserTransformer(User::findOrFail($userId), $embeds));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTransformer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $user;</span><br><span class="line"><span class="keyword">protected</span> $embeds;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $embeds = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line"><span class="keyword">$this</span>-&gt;embeds = $embeds;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $append = [];</span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="string">'friends'</span>, <span class="keyword">$this</span>-&gt;embeds)) &#123;</span><br><span class="line">        <span class="comment">// If you have more than one embed, you'll want to generalize this</span></span><br><span class="line">        $append[<span class="string">'friends'</span>] = <span class="keyword">$this</span>-&gt;user-&gt;friends-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($friend)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">new</span> FriendTransformer($friend))-&gt;toArray();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> array_merge([</span><br><span class="line">    <span class="string">'id'</span> =&gt; <span class="keyword">$this</span>-&gt;user-&gt;id,</span><br><span class="line">    <span class="string">'name'</span> =&gt; sprintf(</span><br><span class="line">        <span class="string">"%s %s"</span>,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user-&gt;first_name,</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user-&gt;last_name</span><br><span class="line">    )</span><br><span class="line">    ], $append);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用laravel-passport-來做api身分驗證"><a class="markdownIt-Anchor" href="#使用laravel-passport-來做api身分驗證"></a> 使用Laravel Passport 來做API身分驗證</h3>
<h4 id="oath-20-簡介"><a class="markdownIt-Anchor" href="#oath-20-簡介"></a> OAth 2.0 簡介</h4>
<h4 id="安裝passport"><a class="markdownIt-Anchor" href="#安裝passport"></a> 安裝Passport</h4>
<p>13-17 使用Passport auth中介層</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/api.php</span></span><br><span class="line">Route::get(<span class="string">'/user'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $request-&gt;user();</span><br><span class="line">&#125;)-&gt;middleware(<span class="string">'auth:api'</span>);</span><br></pre></td></tr></table></figure>
<p>13-18 使用Bearer權杖來發抒簡單的API請求</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$http = <span class="keyword">new</span> GuzzleHttp\Client;</span><br><span class="line">$response = $http-&gt;request(<span class="string">'GET'</span>, <span class="string">'http://speakr.dev/api/user'</span>, [</span><br><span class="line">    <span class="string">'headers'</span> =&gt; [</span><br><span class="line">        <span class="string">'Accept'</span> =&gt; <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="string">'Authorization'</span> =&gt; <span class="string">'Bearer '</span> . $accessToken,</span><br><span class="line">    ],</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<h4 id="passport的api"><a class="markdownIt-Anchor" href="#passport的api"></a> Passport的API</h4>
<h4 id="passport可用的授權類型"><a class="markdownIt-Anchor" href="#passport可用的授權類型"></a> Passport可用的授權類型</h4>
<p>13-19 使用密碼授權類型來發出請求</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assuming SpaceBook is not an external app, but actually</span></span><br><span class="line"><span class="comment">// a trusted internal app... this is SpaceBook's routes/web.php</span></span><br><span class="line">Route::get(<span class="string">'speakr/password-grant-auth'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    $http = <span class="keyword">new</span> GuzzleHttp\Client;</span><br><span class="line">    $response = $http-&gt;post(<span class="string">'http://speakr.dev/oauth/token'</span>, [</span><br><span class="line">    <span class="string">'form_params'</span> =&gt; [</span><br><span class="line">        <span class="string">'grant_type'</span> =&gt; <span class="string">'password'</span>,</span><br><span class="line">        <span class="string">'client_id'</span> =&gt; config(<span class="string">'speakr.id'</span>),</span><br><span class="line">        <span class="string">'client_secret'</span> =&gt; config(<span class="string">'speakr.secret'</span>),</span><br><span class="line">        <span class="string">'username'</span> =&gt; <span class="string">'matt@mattstauffer.co'</span>,</span><br><span class="line">        <span class="string">'password'</span> =&gt; <span class="string">'my-speakr-password'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ]);</span><br><span class="line">    $thisUsersTokens = json_decode((string) $response-&gt;getBody(), <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// do stuff with the tokens</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="密碼授權"><a class="markdownIt-Anchor" href="#密碼授權"></a> 密碼授權</h4>
<h4 id="授權密碼授予"><a class="markdownIt-Anchor" href="#授權密碼授予"></a> 授權密碼授予</h4>
<p>13-20 一個取用者app將用戶轉址到OAuth伺服器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In SpaceBook's routes/web.php:</span></span><br><span class="line">Route::get(<span class="string">'speakr/redirect'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    $query = http_build_query([</span><br><span class="line">        <span class="string">'client_id'</span> =&gt; config(<span class="string">'speakr.id'</span>),</span><br><span class="line">        <span class="string">'redirect_uri'</span> =&gt; url(<span class="string">'speakr/callback'</span>),</span><br><span class="line">        <span class="string">'response_type'</span> =&gt; <span class="string">'code'</span>,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="comment">// Builds a string like:</span></span><br><span class="line">    <span class="comment">// client_id=&#123;$client_id&#125;&amp;redirect_uri=&#123;$redirect_uri&#125;&amp;response_type=code</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'http://speakr.dev/oauth/authorize?'</span> . $query);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>13-21 我們的取用app中的授權回呼路由</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In SpaceBook's routes/web.php:</span></span><br><span class="line">Route::get(<span class="string">'speakr/callback'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'error'</span>)) &#123;</span><br><span class="line">    <span class="comment">// handle error condition</span></span><br><span class="line">    &#125;</span><br><span class="line">$http = <span class="keyword">new</span> GuzzleHttp\Client;</span><br><span class="line">$response = $http-&gt;post(<span class="string">'http://speakr.dev/oauth/token'</span>, [</span><br><span class="line"><span class="string">'form_params'</span> =&gt; [</span><br><span class="line">    <span class="string">'grant_type'</span> =&gt; <span class="string">'authorization_code'</span>,</span><br><span class="line">    <span class="string">'client_id'</span> =&gt; config(<span class="string">'speakr.id'</span>),</span><br><span class="line">    <span class="string">'client_secret'</span> =&gt; config(<span class="string">'speakr.secret'</span>),</span><br><span class="line">    <span class="string">'redirect_uri'</span> =&gt; url(<span class="string">'speakr/callback'</span>),</span><br><span class="line">    <span class="string">'code'</span> =&gt; $request-&gt;code,</span><br><span class="line">    ],</span><br><span class="line">]);</span><br><span class="line">$thisUsersTokens = json_decode((string) $response-&gt;getBody(), <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// do stuff with the tokens</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="使用刷新權杖"><a class="markdownIt-Anchor" href="#使用刷新權杖"></a> 使用刷新權杖</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AuthServiceProvider's boot() method</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerPolicies();</span><br><span class="line">    Passport::routes();</span><br><span class="line">    <span class="comment">// How long a token lasts before needing refreshing</span></span><br><span class="line">    Passport::tokensExpireIn(</span><br><span class="line">        Carbon::now()-&gt;addDays(<span class="number">15</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// How long a refresh token will last before re-auth</span></span><br><span class="line">    Passport::refreshTokensExpireIn(</span><br><span class="line">        Carbon::now()-&gt;addDays(<span class="number">30</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In SpaceBook's routes/web.php:</span></span><br><span class="line">Route::get(</span><br><span class="line"><span class="string">'speakr/request-refresh'</span>,</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(Request $request)</span> </span>&#123;</span><br><span class="line">    $http = <span class="keyword">new</span> GuzzleHttp\Client;</span><br><span class="line">    $params = [</span><br><span class="line">        <span class="string">'grant_type'</span> =&gt; <span class="string">'refresh_token'</span>,</span><br><span class="line">        <span class="string">'client_id'</span> =&gt; config(<span class="string">'speakr.id'</span>),</span><br><span class="line">        <span class="string">'client_secret'</span> =&gt; config(<span class="string">'speakr.secret'</span>),</span><br><span class="line">        <span class="string">'redirect_uri'</span> =&gt; url(<span class="string">'speakr/callback'</span>),</span><br><span class="line">        <span class="string">'refresh_token'</span> =&gt; $theTokenYouSavedEarlier,</span><br><span class="line">    ];</span><br><span class="line">    $response = $http-&gt;post(</span><br><span class="line">        <span class="string">'http://speakr.dev/oauth/token'</span>,</span><br><span class="line">        [<span class="string">'form_params'</span> =&gt; $params,]</span><br><span class="line">    );</span><br><span class="line">    $thisUsersTokens = json_decode(</span><br><span class="line">        (string) $response-&gt;getBody(),</span><br><span class="line">        <span class="keyword">true</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// do stuff with the tokens</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="使用刷新權杖-2"><a class="markdownIt-Anchor" href="#使用刷新權杖-2"></a> 使用刷新權杖</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="個人造訪權杖"><a class="markdownIt-Anchor" href="#個人造訪權杖"></a> 個人造訪權杖</h4>
<h4 id="laravel-session-認證產生的權杖"><a class="markdownIt-Anchor" href="#laravel-session-認證產生的權杖"></a> Laravel session 認證產生的權杖</h4>
<h4 id="json-web-tokenjwt"><a class="markdownIt-Anchor" href="#json-web-tokenjwt"></a> JSON Web Token(JWT)</h4>
<p>13-22</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.ajaxSetup(&#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">    <span class="string">'X-CSRF-TOKEN'</span>: <span class="string">"&#123;&#123; csrf_token() &#125;&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="使用passwort-api與vue元件來管理用戶端與權杖"><a class="markdownIt-Anchor" href="#使用passwort-api與vue元件來管理用戶端與權杖"></a> 使用Passwort API與Vue元件來管理用戶端與權杖</h4>
<h4 id="路由"><a class="markdownIt-Anchor" href="#路由"></a> 路由</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/oauth/clients (GET, POST)</span><br><span class="line">/oauth/clients/&#123;id&#125; (DELETE, PUT)</span><br><span class="line">/oauth/personal-access-tokens (GET, POST)</span><br><span class="line">/oauth/personal-access-tokens/&#123;id&#125; (DELETE)</span><br><span class="line">/oauth/scopes (GET)</span><br><span class="line">/oauth/tokens (GET)</span><br><span class="line">/oauth/tokens/&#123;id&#125; (DELETE)</span><br></pre></td></tr></table></figure>
<h4 id="vue元件"><a class="markdownIt-Anchor" href="#vue元件"></a> Vue元件</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan vendor:publish --tag=passport-components</span><br></pre></td></tr></table></figure>
<p>13-23 將Passport的Vue元件匯入app.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="密碼範圍"><a class="markdownIt-Anchor" href="#密碼範圍"></a> 密碼範圍</h4>
<p>13-24 定義Passport範圍</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>13-25 請求身分驗證來使用特定的範圍</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>13-26 檢查一個user用來驗證的權狀是否可執行指定的動作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>13-27 使用中介層，根據權杖範圍來限制使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="laravel-52-api-權杖驗證"><a class="markdownIt-Anchor" href="#laravel-52-api-權杖驗證"></a> Laravel 5.2 + API 權杖驗證</h4>
<p>13-28 對路由群組套用API auth中介層</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>, <span class="string">'middleware'</span> =&gt; <span class="string">'auth:api'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">user = auth()-&gt;guard(<span class="string">'api'</span>)-&gt;user();</span><br></pre></td></tr></table></figure>
<p>13-29 常見API測試模式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DogsApiTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">WithoutMiddleware</span>, <span class="title">DatabaseMigrations</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_it_gets_all_dogs</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;be(factory(User::class)-&gt;create());</span><br><span class="line">        $dog1 = factory(Dog::class)-&gt;create();</span><br><span class="line">        $dog2 = factory(Dog::class)-&gt;create();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;visit(<span class="string">'api/dogs'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;seeJson([</span><br><span class="line">            <span class="string">'name'</span> =&gt; $dog1-&gt;name</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;seeJson([</span><br><span class="line">            <span class="string">'name'</span> =&gt; $dog2-&gt;name</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
    </section>
</article>



<a id="pagenext" href="/2020/06/29/laravel-12/" class="article-next" title="laravel-12 測試"><i class="icon-arrow-right"></i></a>




<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "7fbe80427f54741e289f",
        clientSecret: "f34ed5fd92e54c9000bd37ba951948cb939deff5",
        repo: "sanonz.github.io",
        owner: "sanonz",
        admin: ["sanonz"],
        id: "2020/06/29/laravel-13",
        distractionFreeMode: true,
        title: "laravel-13 編寫API",
        body: "http://vince115.github.io/2020/06/29/laravel-13/",
        labels: []
    }).render('comments');
    </script>
</div>


            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
